name: polarfire-kernel
summary: A RISC-V 64-bit kernel for the Microchip Polarfire SoC Icecicle
description: |
  A RISC-V 64-bit kernel for the Microchip Polarfire SoC Icecicle
type: kernel
build-base: core22
adopt-info: kernel

architectures:
  - build-on: [amd64, riscv64]
    build-for: [riscv64]

confinement: strict

package-repositories:
  - type: apt
    ppa: snappy-dev/image

parts:
  firmware:
    plugin: nil
    stage-packages:
      - linux-firmware
      - wireless-regdb
    organize:
      lib/firmware: firmware
    stage:
      - -lib
      - -usr
      # Remove firmware files for things that will never be needed
      - -firmware/mellanox
      - -firmware/mrvl
      - -firmware/qcom
      - -firmware/netronome
      - -firmware/intel
      - -firmware/liquidio
      - -firmware/i915
      - -firmware/brcm
      - -firmware/qed

  kernel:
    plugin: nil
    stage-packages:
      - linux-generic:${CRAFT_TARGET_ARCH}
    override-build: |
      craftctl default

      KERNEL_VER="$(ls ${CRAFT_PART_INSTALL}/lib/modules)"
      echo ${KERNEL_VER} > ${CRAFT_PART_INSTALL}/.kernel_ver

      depmod -a -b ${CRAFT_PART_INSTALL} ${KERNEL_VER}

      craftctl set version="${KERNEL_VER}"
      craftctl set grade="stable"
    stage:
      - Image
      - modules
      - dtbs
      - .kernel_ver
    prime:
      - modules
    organize:
      boot/vmlinuz-*: Image
      lib/modules/*: modules
      lib/firmware/*/device-tree: dtbs

  # In order to support cross-compilation, we need to do a few tricks with
  # downloading the initramfs package for the target arch
  ubuntu-core-initramfs:
    plugin: nil
    override-pull: |
      apt-get download ubuntu-core-initramfs:riscv64
    override-build: |
      dpkg -x ubuntu-core-initramfs*_riscv64.deb \
        ${CRAFT_PART_INSTALL}
    organize:
      usr/lib/ubuntu-core-initramfs: ubuntu-core-initramfs
    prime:
      - -*

  initrd:
    plugin: nil
    after:
      - kernel
      - ubuntu-core-initramfs
      - firmware
    build-packages:
      # Use the native package to actually build the initrd
      - ubuntu-core-initramfs
    override-build: |
      KERNEL_VERSION=$(cat ${CRAFT_STAGE}/.kernel_ver)
      ubuntu-core-initramfs create-initrd \
        --kernelver=${KERNEL_VERSION} \
        --kerneldir=${CRAFT_STAGE}/modules \
        --skeleton=${CRAFT_STAGE}/ubuntu-core-initramfs \
        --firmwaredir=${CRAFT_STAGE}/firmware \
        --output=${CRAFT_PART_INSTALL}/initrd.img
    organize:
      # Remove version suffix
      initrd.img*: initrd.img
    prime:
      - -*

  fit-image:
    after:
      - kernel
      - initrd
    plugin: dump
    source: fit-image/
    build-packages:
      - u-boot-tools
    override-build: |
      mkimage \
        -f fitImage-riscv64.its \
        ${CRAFT_PART_INSTALL}/kernel.img
